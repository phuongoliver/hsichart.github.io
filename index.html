<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSI Data Viewer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        
        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        select {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            min-width: 300px;
        }

        .loading { text-align: center; color: #666; display: none; font-style: italic; margin-top: 10px;}
        canvas { max-height: 550px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h2>üîç Hyperspectral Signature Viewer</h2>
    
    <div class="control-panel">
        <label for="fileSelect"><strong>Ch·ªçn d·ªØ li·ªáu:</strong></label>
        <select id="fileSelect">
            <option value="" disabled selected>-- ƒêang t·∫£i danh s√°ch... --</option>
        </select>
        <button onclick="loadSelectedData()" style="padding: 8px 15px; cursor: pointer;">T·∫£i l·∫°i bi·ªÉu ƒë·ªì</button>
    </div>

    <div id="loadingMsg" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    
    <div style="position: relative;">
        <canvas id="myChart"></canvas>
    </div>
    
    <p style="text-align: center; font-size: 0.85em; color: #888; margin-top: 10px;">
        * LƒÉn chu·ªôt ƒë·ªÉ Zoom - Gi·ªØ chu·ªôt tr√°i ƒë·ªÉ Pan - Double click ƒë·ªÉ Reset Zoom
    </p>
</div>

<script>
    let myChart = null;
    const DATA_FOLDER = './data/'; // ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi t·ªõi folder data

    // 1. T·ª± ƒë·ªông ch·∫°y khi trang web t·∫£i xong
    document.addEventListener('DOMContentLoaded', async () => {
        await loadIndexFile();
    });

    // 2. H√†m ƒë·ªçc file index.json ƒë·ªÉ t·∫°o danh s√°ch dropdown
    async function loadIndexFile() {
        const selectEl = document.getElementById('fileSelect');
        try {
            const response = await fetch(DATA_FOLDER + 'index.json');
            if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file index.json");
            
            const fileList = await response.json();
            
            // X√≥a c√°c option c≈©
            selectEl.innerHTML = '<option value="" disabled selected>-- Ch·ªçn file ƒë·ªÉ hi·ªÉn th·ªã --</option>';

            if (fileList.length === 0) {
                selectEl.innerHTML = '<option disabled>Kh√¥ng c√≥ d·ªØ li·ªáu n√†o</option>';
                return;
            }

            // Th√™m option m·ªõi
            fileList.forEach(filename => {
                const option = document.createElement('option');
                option.value = filename;
                option.textContent = filename;
                selectEl.appendChild(option);
            });

            // L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn file kh√°c
            selectEl.addEventListener('change', loadSelectedData);

        } catch (error) {
            console.error(error);
            selectEl.innerHTML = '<option disabled>L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c index.json</option>';
            alert("L·ªói: Vui l√≤ng ch·∫°y Local Server (python -m http.server) ƒë·ªÉ ƒë·ªçc ƒë∆∞·ª£c file JSON.");
        }
    }

    // 3. H√†m t·∫£i d·ªØ li·ªáu c·ªßa file ƒë∆∞·ª£c ch·ªçn v√† v·∫Ω bi·ªÉu ƒë·ªì
    async function loadSelectedData() {
        const filename = document.getElementById('fileSelect').value;
        if (!filename) return;

        const loading = document.getElementById('loadingMsg');
        loading.style.display = 'block';

        try {
            const response = await fetch(DATA_FOLDER + filename);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            renderChart(data);
        } catch (error) {
            console.error("L·ªói t·∫£i file data:", error);
            alert(`Kh√¥ng th·ªÉ t·∫£i file: ${filename}`);
        } finally {
            loading.style.display = 'none';
        }
    }

    // 4. H√†m v·∫Ω bi·ªÉu ƒë·ªì
    function renderChart(data) {
        const ctx = document.getElementById('myChart').getContext('2d');

        const mean = data.mean;
        const std = data.std;
        
        // T√≠nh to√°n v√πng Upper/Lower bound cho Std Dev
        const upper = mean.map((v, i) => v !== null ? v + std[i] : null);
        const lower = mean.map((v, i) => v !== null ? v - std[i] : null);

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Mean Spectrum',
                        data: mean,
                        borderColor: 'rgb(220, 53, 69)', // M√†u ƒë·ªè ƒë·∫≠m
                        backgroundColor: 'rgb(220, 53, 69)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        tension: 0.2
                    },
                    {
                        label: '+Std Dev',
                        data: upper,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(220, 53, 69, 0.2)', // M√†u ƒë·ªè nh·∫°t
                        pointRadius: 0,
                        fill: '+1', 
                        tension: 0.2
                    },
                    {
                        label: '-Std Dev',
                        data: lower,
                        borderColor: 'transparent',
                        backgroundColor: 'transparent',
                        pointRadius: 0,
                        fill: false,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: true, text: `Ph·ªï ph·∫£n x·∫°: ${data.filename}`, font: {size: 18} },
                    
                    // --- PH·∫¶N ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A ---
                    tooltip: {
                        callbacks: {
                            // 1. Thay ƒë·ªïi Ti√™u ƒë·ªÅ Tooltip th√†nh gi√° tr·ªã Y (Reflectance)
                            title: function(tooltipItems) {
                                const yValue = tooltipItems[0].parsed.y;
                                return `Reflectance: ${yValue.toFixed(4)}`;
                            },
                            // 2. Thay ƒë·ªïi N·ªôi dung Tooltip th√†nh gi√° tr·ªã X (Wavelength)
                            label: function(context) {
                                if (context.dataset.label === 'Mean Spectrum') {
                                    return `Wavelength: ${context.label} nm`;
                                }
                                return null; // ·∫®n tooltip cho c√°c ƒë∆∞·ªùng Std Dev
                            }
                        }
                    },
                    // ---------------------------

                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                        },
                        pan: { enabled: true, mode: 'x' },
                        limits: { y: { min: 0, max: 1.2 } }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Wavelength (nm)' } },
                    y: { title: { display: true, text: 'Surface Reflectance' }, min: 0 }
                }
            }
        });
    }
</script>

</body>
</html>